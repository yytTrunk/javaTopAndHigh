# redis

### 一 为什么要用redis？

redis(REmote Dictionary Server 远程字典服务器)。

主要应用于缓存和队列

#### redis特点

1. **支持数据类型丰富**，
2. **高性能**，Redis 数据库中的所有数据都存储在内存中，读写速度快。
3. **支持持久化**，同时还可以将数据异步写入到硬盘 中，保证数据持久化
4. **使用简单**，提供了100多个命令，并且开源



### 二 为什么要用redis做缓存？

1. 能够为每个键设置生存时间，生存时间到期后，键会被自动删除
2. 



### 三 redis支持哪几种数据类型？

 	1. **String 字符串类型**，一个字符串类型键允许存储最大容量为512M。其实其它数据类型可以理解均为字符串类型的组织形式不同。
 	2. **hash(字典) 散列类型**，采用键值对存储。适合存储对象，使用对象类别和ID构成键名，使用字段表示属性。例如，存储文章数据。
 	3. **list 列表类型**，存储有序字符串列表，基于双向链表实现，向列表两端插入元素快，获取靠近两段元素快。例如，记录日志，不会受到日志总条数影响；存储文章ID、评论列表。
 	4. **set 集合类型**，采用值为空的散列表（hash table）实现，无序、不能重复。例如，存储文章标签。（其底层数据结构类似于Java中HashMap）
 	5. **sorted set 有序集合类型**，在set集合类型基础上，变得有序，基于散列表和跳跃表实现。与list列表类型的底层实现原理不同。例如，按点击率排序

![redis数据结构](.\img\02_01.PNG)



### 四 redis核心原理

#### 4.1 redis是单线程，为什么还那么快？

1. redis中数据都存储在内存中，读取写入速度更快，可以达到ns级别
2. 单线程避免了多线程的切换，因此不建议使用耗时较长的命令，如keys命令
3. 基于epoll实现IO多路复用，来高效处理多个客户端请求

#### 4.2 redis单线程如何处理多个并发客户端的连接？

redis是利用epoll实现IO多路复用，当多个客户端请求或事件过来时，将连接信息和事件放到队列中。每个操作会对应不同的事件，依次连接事件放到事件分派器上，事件分派器将事件分发到对应事件处理器上。

事件处理器包括，连接应答处理器、命令请求处理器、命令回复处理器。

![redis多路复用](.\img\02_02.PNG)

### 4.3 持久化

持久化是指Redis能够将数据从内存中同步到硬盘中，使得重启后仍然能够根据硬盘中记录恢复数据。

redis支持两种方式的持久化，RDB和AOF。

#### RDB

**采取方式**  定时将内存中的数据生成一份副本同步到硬盘上，该过程称为快照。默认保存在dump.rdb二进制文件中。采用N秒内有M个改动时，会生成快照。

**存在问题** 采用N秒内有M个改动时，当操作不满足M次时，如60s内有1000次操作，生成快照，当为999次，结束，此时会造成数据丢失。

#### AOF (append only file)

**采取方式** 每次执行命令后，将命令本身记录下来。当redis重新启动时，会重新执行AOF文件的命令，达到redis启动前的状态。可以配置多久将修改的命令写入文件中，即多久执行一次fsync命令将命令写入硬盘中。

**推荐** 也是默认，每秒fsync一次，此时能够兼顾速度和安全。

**存在问题** 当存入命令过多时，重新启动redis，速度会比较慢。

#### 两种方式如何选择？

**RDB** 快照方式备份数据库，启动较快，但会数据丢失

**AOF** 不会造成数据丢失，但是存入命令过多时，重新启动redis，速度会比较慢

**因此，在redis4.0时，支持了混合持久化？**

```java
// 先要开启aof持久化
// 默认不开启，开启命令
aof-use-rdb-preamble yes
```

AOF重写会将记录的多个重复命令进行重写（如set key value，重复了10次，重写后将只记录一次，会加上次数，然后生成新的aof文件）。在重写时，还会将之前的内存rdb快照文件内容和新增的AOF记录的命令，存放在一起，共同写入新的aof临时文件中，写入完成后，生成appendonly.aof文件，覆盖原先存在的aof文件。

重写过程，其它客户端，新增的修改命令，会记录到AOF格式文件中，避免丢失。appendonly.aof包含RDB格式和AOF格式两部分，AOF格式用来记录命令。

AOF能够根据配置在后台自动重写，也可以通过命令bgrewriteaof重写AOF。

**总结** 混合持久化方式实际就是将RDB方式与AOF方式，想办法进行结合，综合两者的优点，RDB的快照，通过补充AOF来记录可能未记录到快照中的命令，然后定时AOF记录的命令，进行重写写入到RDB快照中，从而避免了记录的AOF文件过大，导致redis重新启动耗时长的问题。

### 4.4 redis缓存淘汰策略？（保证在有限内存中，redis尽可能为热点数据）

#### 缓存淘汰策略指什么？

redis数据存放在内存中，内存相对于硬盘，虽然速度快，但是容量有限，如何保证redis中存放数据尽可能为热点数据，使得在有限的内存大小情况下，保证数据访问的速度。此时，可以考虑使用redis的缓存淘汰策略。

当配置redis可用内存后，如果超出内存，会导致redis性能下降，使得redis使用效率下降。可以通过配置参数最大内存maxmemory来限制redis可以存储的容量。当超出后，将执行缓存淘汰策略，redis中包含如下几种淘汰策略，可通过参数maxmemory-policy 配置，默认为noeviction。

- **noeviction** （默认）

不能执行写请求，只能读取数据，可以保证不会丢失数据，但是redis已经基本丧失了部分功能。

- **volatile-lru** （Iru， Least Recently Used， 最少使用）

尝试淘汰设置了过期时间中最少使用的数据

- **volatile-ttl**

尝试淘汰设置了过期时间，且快要过期的数据，ttl越小越优先被淘汰

- **volatile-random**

尝试淘汰设置了过期时间，中随机进行淘汰

- **allkeys-lru**

全体key集合中，使用最少的数据。

- **allkeys-random**

全体key集合中，随机淘汰

**总结**：

1. volatile-XXX，只会淘汰设置了过期时间的数据。allkeys-XXX，针对所有数据。
2. 因此，如果使用了持久化，使用volatile-XXX，能够保证不会过期的数据，能够长时间保存，不会淘汰。
3. 当仅使用redis作为缓存时，没有配置数据过期时间时，可以配置为allkeys-XXX。
4. 通常，更多使用lru



### 五 redis集群

#### 5.1 什么是哨兵模式

































### 四 redis基本特性，事务、生成时间、排序、消息队列、管道

#### 4.1 redis事务？

redis支持事务，操作都是原子性，是对数据的更改要么全部执行，要么全部不执行。但是redis事务不支持回滚。

例如对于运行时命令，1,2,3, 1执行完，2执行出错，3还是会执行，同时1,3的执行结果都会生效。

##### 命令MULTI、EXEC

包含在MULTI、EXEC间的命令执行完，才能返回各个命令执行结果

##### 命令WATCH

用于一个键或者多个键，一旦其中一个键被修改，之后事务将不再执行，直至执行到EXEC命令。

可以通过使用上述三个命令组合，实现事务操作。

#### 4.2 生存时间？

```
// 设置键生存时间
EXPIRE key seconds
```

**应用**  **实现访问频率控制**

设置用户IP为key，1分钟，最大访问次数为100，超过100次提示报错，1分钟到，重新统计

**应用**  **实现缓存**

常使用信息，存入redis，设置生成时间1小时，若超过时间，需要重新读取数据。

同时可以设置参数，配置Redis最大可用内存，避免同时存在键过多，导致占用过大内存，从而制定规则来淘汰部分键。

#### 4.3 排序

通过sort命令，能够对集合、列表、有序集合进行排序

通过by，指令某个参数进行排序。

sort时间复杂度O(n+mlogm)， n为列表元素个数，m为要返回元素个数

**提高性能使用原则：**

1. 尽可能减少排序键中元素个数，减小n
2. 使用limit只获取需要数据，减少m
3. 若排序数据量较大，使用store参数将结果缓存

排序底层实现采用**部分快速排序算法**

#### 4.4 redis实现消息队列（任务队列）

RPOP命令，能够不断从键中取出元素

BRPOP命令，没有元素会阻塞，直到有元素加入

#### 4.5 发布订阅

PUBLISH命令，发布者向指定频道发布消息

SUBSCRIBE命令，接收着从指定频道接收消息

#### 4.6 管道

redis server和client通过TCP协议连接，消息来回自server端和client的耗时，称为往返时延。

可通过管道，一次性发送多条命令，在执行完成后一次性将结果返回，减少server和client端的通信次数，降低总体时延。







### 六 redis集群？

#### 6.1 复制

**特征**

1. 指一台数据库中数据更新后，自动将更新的数据同步到其它数据库上。
2. 复制中包含主从数据库，主数据库可以有多个从数据库，每个从数据库只对应一个主数据库。
3. 从数据库一般是只读。

**实现**

从数据库，启动加上额外配置参数

```java
slaveof 主数据库地址 主数据库端口
```

**原理**

复制在不同redis版本进行了多次优化

**应用**

- 读写分离与一致性
- 从数据库持久化，
- 无硬盘复制
- 增量复制，主从断线重连后增量复制

### 6.2 哨兵

**功能**

1. 监控主数据库和从数据库是否正常运行
2. 主数据库出现故障自动将从数据库转化为主数据库



### 6.3 集群





























