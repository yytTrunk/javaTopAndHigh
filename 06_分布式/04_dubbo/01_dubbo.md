# dubbo

## 一 dubbo工作原理是什么？

| 编号 | 分层                    | 作用                                                         |
| ---- | ----------------------- | ------------------------------------------------------------ |
| 1    | service层，接口层       | 给服务提供者和消费者来实现的                                 |
| 2    | config层，配置层        | 主要是对dubbo进行各种配置的                                  |
| 3    | proxy层，服务代理层     | 透明生成客户端的stub和服务端的skeleton，通过接口生成动态代理对象 |
| 4    | registry层，服务注册层  | 负责服务的注册与发现                                         |
| 5    | cluster层，集群层       | 封装多个服务提供者的路由以及负载均衡，将多个实例组合成一个服务 |
| 6    | monitor层，监控层       | 对rpc接口的调用次数和调用时间进行监控                        |
| 7    | protocol层，远程调用层  | 封装rpc调用                                                  |
| 8    | exchange层，信息交换层  | 封装请求响应模式，同步转异步                                 |
| 9    | transport层，网络传输层 | 抽象mina和netty为统一接口                                    |
| 10   | serialize层             | 数据序列化层                                                 |

流程图

![dubbo流程](https://gitee.com/codeyyt/my_pic/raw/master/image-blog/javath/06/04/04_01.png)

如果服务注册中心挂掉了，仍然可以通信，因为消费者会将服务提供则的信息拉取到消费者本地。

**参考**

https://blog.csdn.net/ityouknow/article/details/100789012



## 二 dubbo支持哪些通信协议？

**dubbo协议（默认）**：采用单一长连接，NIO异步通信，基于hessian作为序列化协议。适用于：传输数据量小（每次请求在 100kb 以内），但是并发量很高，及服务消费者机器数远大于服务提供者机器数的情况。

**其它**：rmi/hessian/http/webservice等。



## 三 dubbo哪些序列化协议？

dubbo实际基于不同的通信协议，支持hessian、java二进制序列化、json、SOAP文本序列化等，但是hessian是其默认的序列化协议。



## 四 dubbo支持哪些负载均衡策略？

Dubbo内置了4种负载均衡策略:

1. RandomLoadBalance:随机负载均衡。随机的选择一个。是Dubbo的**默认**负载均衡策略。
2. RoundRobinLoadBalance:轮询负载均衡。轮询选择一个。
3. LeastActiveLoadBalance:最少活跃调用数，相同活跃数的随机。活跃数指调用前后计数差。使慢的 Provider 收到更少请求，因为越慢的 Provider 的调用前后计数差会越大。
4. ConsistentHashLoadBalance:一致性哈希负载均衡。相同参数的请求总是落在同一台机器上。



## 五 dubbo支持哪些集群容错策略？

Dubbo主要内置了如下几种策略：

- Failover(失败自动切换)（默认）

当调用出现失败的时候，根据配置的重试次数，会自动从其他可用地址中重新选择一个可用的地址进行调用，直到调用成功，或者是达到重试的上限位置。Dubbo里默认配置的重试次数是2。

- Failsafe(失败安全)

即使失败了也不会影响整个调用流程。当出现调用失败时，会忽略此错误，并记录一条日志，同时返回一个空结果，在上游看来调用是成功的。应用场景，可以用于写入审计日志等操作。

- Failfast(快速失败)

失败立即报错，让调用方来决定下一步的操作并保证业务的幂等性。

- Failback(失败自动恢复)

Failback策略中，如果调用失败，则此次失败相当于`Failsafe`，将返回一个空结果。而与`Failsafe`不同的是，Failback策略会将这次调用加入内存中的失败列表中，对于这个列表中的失败调用，会在另一个线程中进行异步重试，重试如果再发生失败，则会忽略，即使重试调用成功，原来的调用方也感知不到了。因此它通常适合于，对于实时性要求不高，且不需要返回值的一些异步操作。

- Forking(并行调用)

一种典型的用成本换时间的思路。即第一次调用的时候就同时发起多个调用，只要其中一个调用成功，就认为成功。在资源充足，且对于失败的容忍度较低的场景下，可以采用此策略。

- Broadcast(广播调用)

在某些场景下，可能需要对服务的所有提供者进行操作，此时可以使用广播调用策略。此策略会逐个调用所有提供者，只要任意有一个提供者出错，则认为此次调用出错。通常用于通知所有提供者更新缓存或日志等本地资源信息。



## 六 dubbo支持哪些服务路由？

服务路由包含一条路由规则，路由规则决定了服务消费者的调用目标，即规定了服务消费者可调用哪些服务提供者。

Dubbo 提供了三种服务路由实现，分别为条件路由 ConditionRouter、脚本路由 ScriptRouter 和标签路由 TagRouter。



## 七 dubbo的SPI机制是什么？

**是什么**

SPI 全称为 Service Provider Interface，是一种服务发现机制。SPI 的本质是将接口实现类的全限定名配置在文件META-INF/services中，并由服务加载器读取配置文件，加载实现类。这样可以在运行时，动态为接口替换实现类。

**应用场景**

应用于插件扩展，新开发插件，接入到开源框架里，来扩展功能。

比如：Java中的JDBC接口，Java中并没有提供实际的实现类。在项目运行时，依据使用到的数据库类型，引入对应jar，如MySQL为mysql-jdbc-connector.jar。

比如：dubbo中的协议扩展、负载均衡扩展、注册中心扩展等。



## 八 dubbo如何进行服务治理，服务降级？

**服务治理**

服务治理主要作用是改变运行时服务的行为和选址逻辑，达到限流，权重配置等目的。

即如何管理服务，使服务能够更加高效运行？

可以生成服务调用链，统计服务访问压力及时长

**服务降级**

服务调用可能出现问题

1) 多个服务之间可能由于服务没有启动或者网络不通，调用中会出现远程调用失败;

2) 服务请求过大，需要停止部分服务以保证核心业务的正常运行；

解决

```java
<dubbo:reference id="xxxService" interface="com.x..service.xxxxService" check="true" async="false" retries="3" timeout="2000" mock="return false" />
```

可以通过配置接口重试次数或者超时时间，出现问题后进行服务降级dubbo提供了mock配置，可以返回固定值或者自定义mock业务处理类进行返回。



## 九 如何设计一个类似dubbo的RPC框架？

依据dubbo的工作原理进行设计

1）可以zookeeper来做服务注册中心

2）消费者如何去注册中心拿服务提供者信息？

3）消费者如何发起服务请求？基于动态代理，调用的接口对应一个代理，代理能够找到服务提供者对应的地址

4）具体哪台设备进行处理？考虑负载均衡

5）如何发送请求网络协议？序列化协议？基于netty网络协议，hessian序列化协议等其它

6）服务提供者如何接收请求？接收到如何处理？通过监听，接收到对应请求后，反序列化，然后进行处理

（也可以包含其它dubbo包含的特性SPI、服务治理等）













