# 分布式生产问题

## 一 如何保证分布式接口幂等性问题

**是什么**

接口可重复调用，在重复调用多次情况下，接口最终得到结果是一致的。

如：重复下单、扣款接口等

**可能出现原因**

- 前端页面重复点击提交	
- 接口超时重试
- 消息重复消费

**常用解决方案**

- 全局唯一ID

  接口下发时存在唯一ID，比如订单支付的orderId唯一，一个订单只能支付一次。

- 数据库去重表

  在处理请求时，先插入一个标识到数据库MySQL中，为唯一键，表明该请求已经被处理过，然后再进行业务处理，如果失败进行操作回滚。如果再重复提交，将不会被处理。

  也可以插入到redis中。

- 状态机

  接口业务处理分为多个步骤，分别对应不同状态，采用有限状态机。如果状态机已经处于下一个状态，这时候来了一个上一个状态的变更，不能够变更，从而保证幂等性。

## 二 如何保证分布式服务接口请求的顺序性？

**方式1** 采用hash将请求分配到同一个设备中

通过前端调用接口请求1、请求2、请求3时，按顺序下发至后端接入服务中，接入服务保证将该3个请求分发至同一台处理系统A中。系统A将3个请求，存入到同一个内存处理队列中，不同内存处理队列对应不同处理线程，每个线程只能处理一个内存队列中的请求，从而保证能够按顺序执行请求。

该种方式需要严格保证请求时按顺序下发，如果出现错乱，后续系统执行时，也不能保证顺序。

**方式2** 分布式锁

多个请求去竞争分布式锁，拿到锁后需要判断是不是能够执行，如果不能会释放锁，让其他请求先执行。











